<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="author" content="æºèˆˆæ‰‹å·¥è›‹æ²">
    <meta name="description" content="æºèˆˆæ‰‹å·¥è›‹æ²å¸¶é ˜å„ä½ä»‹ç´¹ï¼Œå„å¼å£å‘³è›‹åŒ…è…¸çš„å‹å¼èˆ‡å£å‘³">
    <meta name="generator" content="Visual Studio Code">
    <meta name="keywords" content="éŸ“å¼æ³¡èœè›‹åŒ…è…¸,æ¿ƒéƒèµ·å¸è›‹åŒ…è…¸,æ—¥å¼æ˜å¤ªå­è›‹åŒ…è…¸,ç¾©å¼é¦™è‰è›‹åŒ…è…¸,é»‘èƒ¡æ¤’è˜‘è‡è›‹åŒ…è…¸,æ³°å¼é…¸è¾£è›‹åŒ…è…¸">
    <!-- æºèˆˆæ‰‹å·¥è›‹æ²ï¼ˆæ›¸ç±¤LOGOï¼‰ -->
     <link rel="short icon" href="favicon-16x16.png">
    <title>æºèˆˆè¤‡åˆå¼å•†åº—éŠæˆ²å°ˆå€</title>
    <style>
        :root {
            --primary: #4cc9f0; --secondary: #e94560; --accent: #f1c40f;
            --bg-dark: #1a1a2e; --panel-bg: rgba(15, 52, 96, 0.95);
        }
        * { box-sizing: border-box; touch-action: manipulation; }
        body { 
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; 
            background-color: var(--bg-dark); color: #e9ecef; 
            margin: 0; padding: 5px; user-select: none;
            display: flex; flex-direction: column; align-items: center;
        }

        #server-notice {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            width: 90%; background: rgba(0, 0, 0, 0.8); border: 1px solid var(--accent);
            color: var(--accent); padding: 5px 10px; border-radius: 20px;
            font-size: 12px; font-weight: bold; text-align: center;
            z-index: 2000; opacity: 0; pointer-events: none;
            box-shadow: 0 0 15px rgba(241, 196, 15, 0.5);
            transition: opacity 0.5s, top 0.5s;
        }
        #server-notice.show { opacity: 1; top: 20px; }

        @keyframes boss-red-pulse {
            0% { box-shadow: 0 0 20px #ff0000; border-color: #ff0000; }
            50% { box-shadow: 0 0 60px #ff0000, inset 0 0 30px #ff0000; border-color: #ff4d4d; transform: scale(1.05); }
            100% { box-shadow: 0 0 20px #ff0000; border-color: #ff0000; }
        }
        .mega-boss-glow { animation: boss-red-pulse 0.5s infinite alternate !important; }

        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-3px, -2px) rotate(-1deg); }
            20% { transform: translate(-5px, 0px) rotate(1deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }
        .apply-shake { animation: shake 0.4s; }

        .coin-particle {
            position: absolute; width: 10px; height: 10px; background: #f1c40f;
            border-radius: 50%; pointer-events: none; z-index: 99;
            box-shadow: 0 0 5px #f1c40f; animation: coin-fly 0.6s ease-out forwards;
        }
        @keyframes coin-fly {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(0.5); opacity: 0; }
        }
        
        h2 { font-size: 1.1rem; margin: 8px 0; color: var(--accent); text-shadow: 0 0 10px rgba(241, 196, 15, 0.5); }
        #main-layout { display: flex; flex-direction: column; width: 100%; max-width: 450px; gap: 8px; transition: transform 0.1s; }

        #ui-layer { 
            display: none; width: 100%; background: var(--panel-bg); 
            padding: 8px; border-radius: 10px; border: 1px solid var(--primary);
            grid-template-columns: 1fr 1fr; gap: 4px; font-size: 12px;
        }
        .stat-box { display: flex; justify-content: space-between; background: rgba(0,0,0,0.3); padding: 3px 6px; border-radius: 4px; }
        .val { color: var(--accent); font-weight: bold; }
        #exp-bar-container { grid-column: span 2; height: 10px; background: #222; border-radius: 5px; overflow: hidden; margin-top: 5px; border: 1px solid #444; }
        #exp-fill { width: 0%; height: 100%; background: linear-gradient(90deg, #2ecc71, #27ae60); transition: width 0.3s; }

        #game-world { 
            position: relative; width: 100%; height: 320px; 
            background: #050505 url('https://www.transparenttextures.com/patterns/stardust.png'); 
            border: 3px solid #0f3460; border-radius: 15px; overflow: hidden; 
        }

        .monster { 
            position: absolute; background-color: #222; border: 2px solid #fff; 
            border-radius: 15px; cursor: pointer; display: flex; 
            flex-direction: column; align-items: center; justify-content: center; 
            z-index: 10; font-size: 40px; transition: transform 0.05s;
        }
        
        .monster.boss { border-color: #00f2fe; box-shadow: 0 0 15px #00f2fe; animation: pulse-blue 1s infinite alternate; }
        .monster.legendary { border-color: #f1c40f; box-shadow: 0 0 20px #f1c40f; animation: pulse-gold 0.6s infinite alternate; }

        .m-name { position: absolute; top: -20px; font-size: 11px; white-space: nowrap; color: white; background: rgba(0,0,0,0.8); padding: 1px 6px; border-radius: 4px; pointer-events: none; border: 1px solid var(--primary); }
        .m-hp-bar { width: 100%; height: 16px; background: #444; position: absolute; bottom: 0; border-radius: 0 0 12px 12px; overflow: hidden; border-top: 1px solid #000; }
        .m-hp-fill { height: 100%; background: linear-gradient(to right, #ff4d4d, #990000); width: 100%; transition: width 0.1s; }
        .hp-text { position: absolute; width: 100%; text-align: center; font-size: 9px; color: white; line-height: 16px; font-weight: bold; text-shadow: 1px 1px 2px #000; z-index: 5; pointer-events: none; }

        #shop-panel { display: none; background: var(--panel-bg); border: 2px solid var(--accent); border-radius: 12px; padding: 10px; flex-direction: column; gap: 5px; }
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        .shop-item { background: rgba(31, 64, 104, 0.8); padding: 5px; border-radius: 8px; border: 1px solid var(--primary); text-align: center; font-size: 11px; }
        .shop-item button { margin-top: 3px; padding: 6px; background: var(--primary); border: none; border-radius: 4px; color: #fff; width: 100%; font-weight: bold; cursor: pointer; }

        #player-profile { display: none; background: var(--panel-bg); border: 1px solid var(--primary); border-radius: 12px; padding: 8px; align-items: center; gap: 10px; }
        #player-avatar-container { width: 55px; height: 55px; border-radius: 50%; border: 2px solid var(--primary); overflow: hidden; background: #000; }
        #player-avatar-img { width: 100%; height: 100%; object-fit: cover; }
        #ult-area { flex-grow: 1; }
        #ult-bar-bg { width: 100%; height: 12px; background: #222; border: 1px solid #444; border-radius: 6px; overflow: hidden; }
        #ult-fill { width: 0%; height: 100%; background: linear-gradient(90deg, #ff4d4d, #f1c40f, #00f2fe); transition: width 0.2s; }
        #p-name-tag { font-size: 16px; color: var(--primary); font-weight: 900; text-shadow: 0 0 5px rgba(76, 201, 240, 0.5); margin-bottom: 2px; }

        .slash-fx { position: absolute; height: 5px; background: #fff; pointer-events: none; z-index: 100; animation: slash-anim 0.1s ease-out forwards; transform-origin: left center; }
        @keyframes slash-anim { 0% { transform: scaleX(0) rotate(var(--rot)); opacity: 1; } 100% { transform: scaleX(3.5) rotate(var(--rot)); opacity: 0; } }

        #start-screen { position: absolute; inset: 0; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .menu-btn { padding: 12px; font-size: 16px; border-radius: 10px; cursor: pointer; color: white; border: none; width: 85%; margin: 5px; font-weight: bold; }
        #log-window { width: 100%; height: 80px; background: #0a0e17; padding: 5px; overflow-y: auto; font-size: 10px; border-radius: 8px; display: none; color: #aaa; border: 1px solid #333; }
        .buy-unit-btn { background: #16213e; color: white; border: 1px solid var(--primary); padding: 5px; font-size: 11px; border-radius: 4px; cursor: pointer; }
        .buy-unit-btn.active { background: var(--secondary); border-color: white; }
    </style>
</head>
<body>

    <h2>æºèˆˆå†’éšªç‰©èª-æ¯€å¤©æ»…åœ°</h2>

    <div id="main-layout">
        <div id="ui-layer">
            <div class="stat-box"><span>ç­‰ç´š</span><span id="p-lv" class="val">1</span></div>
            <div class="stat-box"><span>é‡‘å¹£</span><span id="p-gold" class="val">$ 0</span></div>
            <div class="stat-box"><span>ç”Ÿå‘½</span><span class="val"><span id="p-hp">100</span>/<span id="p-max">100</span></span></div>
            <div class="stat-box"><span>æ”»æ“Š</span><span id="p-atk" class="val">25</span></div>
            <div class="stat-box"><span>é˜²ç¦¦</span><span id="p-def" class="val">10</span></div>
            <div class="stat-box"><span>æ“Šæ®º</span><span id="p-kills" class="val">0</span></div>
            <div id="exp-bar-container"><div id="exp-fill"></div></div>
        </div>

        <div id="game-world">
            <div id="server-notice"></div>
            <div id="start-screen">
                <h1 style="color:#ff0000; font-size: 20px; text-shadow: 0 0 15px #ff0000;">ğŸ® æ¯€å¤©æ»…åœ°ç‰ˆæœ¬ ğŸ®</h1>
                <input type="text" id="name-input" style="padding:10px; width:80%; border-radius:8px; text-align:center; margin-bottom:15px; background: #222; color: white; border: 1px solid var(--primary);" placeholder="è«‹è¼¸å…¥å‹‡è€…ç¨±è™Ÿ" maxlength="8">
                <button class="menu-btn" style="background:var(--secondary);" onclick="startNew()">âš”ï¸ é–‹å§‹å†’éšªï¼ˆé–‹å±€é€10è¬é‡‘å¹£ï¼‰</button>
                <button class="menu-btn" id="load-btn" style="background:#2980b9; display:none;" onclick="loadGame()">ğŸ“œ è¼‰å…¥é€²åº¦</button>
            </div>
        </div>

        <div id="player-profile">
            <div class="avatar-wrap">
                <div id="p-name-tag">å‹‡è€…</div>
                <div id="player-avatar-container" onclick="document.getElementById('avatar-input').click()">
                    <div id="def-icon" style="font-size:30px; text-align:center; line-height:55px;">ğŸ‘¤</div>
                    <img id="player-avatar-img" style="display:none;">
                </div>
            </div>
            <input type="file" id="avatar-input" hidden onchange="handleAvatar(this)">
            <div id="ult-area">
                <div style="font-size: 10px; color: #00f2fe; margin-bottom: 2px; font-weight: bold; display: flex; justify-content: space-between;">
                    <span>ULTIMATE SKILL</span><span id="ult-pct">0%</span>
                </div>
                <div id="ult-bar-bg"><div id="ult-fill"></div></div>
                <button id="auto-toggle" onclick="toggleAuto()" style="margin-top:5px; width: 100%; background: #8e44ad; color: white; border: none; border-radius: 4px; padding: 4px; font-size: 11px; font-weight: bold; cursor: pointer;">ğŸ¤– è‡ªå‹•æ›æ©Ÿï¼šé—œé–‰</button>
            </div>
        </div>

        <div id="shop-panel">
            <div style="display:flex; gap:5px; margin-bottom:5px;">
                <button class="buy-unit-btn active" id="unit-1" onclick="setBuyUnit(1, this)">x1</button>
                <button class="buy-unit-btn" id="unit-10" onclick="setBuyUnit(10, this)">x10</button>
                <button class="buy-unit-btn" id="unit-max" style="background:var(--accent); color:black;" onclick="setBuyUnit('max', this)">MAX</button>
            </div>
            <div class="shop-grid">
                <div class="shop-item"><span>ğŸ’ª æ”»æ“ŠåŠ›</span><br><span id="price-atk" style="color:var(--accent)">$ 500</span><button onclick="buy('atk')">å¼·åŒ–</button></div>
                <div class="shop-item"><span>ğŸ›¡ï¸ é˜²ç¦¦åŠ›</span><br><span id="price-def" style="color:var(--accent)">$ 500</span><button onclick="buy('def')">å¼·åŒ–</button></div>
                <div class="shop-item"><span>â¤ï¸ æå‡ç”Ÿå‘½</span><br><span id="price-hp" style="color:var(--accent)">$ 800</span><button onclick="buy('hp')">è³¼è²·</button></div>
                <div class="shop-item"><span>ğŸ’Š é£›å‡è—¥ä¸¸</span><br><span id="price-lv" style="color:var(--accent)">$ 5k</span><button onclick="buyLv()" style="background:var(--accent); color:black;">çªç ´</button></div>
            </div>
        </div>

        <div id="log-window"></div>
        <div id="quick-actions" style="display:none; justify-content:center; gap:8px;">
            <button onclick="saveGame(true)" style="padding:6px 12px; background:#27ae60; color:white; border:none; border-radius:5px; font-size:11px;">ğŸ’¾ å¿«é€Ÿå­˜æª”</button>
            <button onclick="exitGame()" style="padding:6px 12px; background:#c0392b; color:white; border:none; border-radius:5px; font-size:11px;">ğŸšª å­˜æª”é€€å‡º</button>
        </div>
    </div>

    <script>
        // --- éŸ³æ•ˆèˆ‡éœ‡å‹•ç³»çµ± ---
        const sounds = {
            bgm: new Audio('https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3'),
            hit: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-fast-sword-whoosh-2792.mp3'),
            kill: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-arcade-retro-changing-tab-206.mp3'),
            lvUp: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-winning-an-extra-bonus-2098.mp3')
        };
        sounds.bgm.loop = true;
        sounds.bgm.volume = 0.3;

        function doVibrate(ms) {
            if ("vibrate" in navigator) {
                navigator.vibrate(ms);
            }
        }

        function playSound(name) {
            const s = sounds[name];
            if(s) {
                const shot = s.cloneNode();
                shot.volume = s.volume;
                shot.play().catch(() => {});
            }
        }

        function unlockAudio() {
            // é»æ“ŠæŒ‰éˆ•æ™‚è§¸ç™¼éŸ³è¨Šèˆ‡éœ‡å‹•è§£é–
            sounds.bgm.play().catch(() => {});
            doVibrate(10); 
        }

        let player = { name: "å‹‡è€…", lv: 1, hp: 100, maxHp: 100, atk: 25, def: 10, exp: 0, expNext: 100, gold: 100000, avatar: null, kills: 0, ult: 0 };
        let buyUnit = 1, isAuto = false, autoTimer = null;
        const zodiacs = [{n:'å­é¼ ', e:'ğŸ­'}, {n:'ä¸‘ç‰›', e:'ğŸ®'}, {n:'å¯…è™', e:'ğŸ¯'}, {n:'å¯å…”', e:'ğŸ°'}, {n:'è¾°é¾', e:'ğŸ²'}, {n:'å·³è›‡', e:'ğŸ'}, {n:'åˆé¦¬', e:'ğŸ´'}, {n:'æœªç¾Š', e:'ğŸ‘'}, {n:'ç”³çŒ´', e:'ğŸµ'}, {n:'é…‰é›', e:'ğŸ”'}, {n:'æˆŒç‹—', e:'ğŸ¶'}, {n:'äº¥è±¬', e:'ğŸ·'}];

        function showServerNotice(msg) {
            const sn = document.getElementById('server-notice');
            sn.innerText = `ğŸ“¢ å…¨æœå…¬å‘Šï¼š${msg}`;
            sn.classList.add('show');
            setTimeout(() => sn.classList.remove('show'), 4000);
        }

        function triggerScreenShake() {
            const layout = document.getElementById('main-layout');
            layout.classList.remove('apply-shake');
            void layout.offsetWidth; 
            layout.classList.add('apply-shake');
            doVibrate(50); // ç•«é¢éœ‡å‹•æ™‚åŒæ­¥è§¸ç™¼æ‰‹æ©Ÿéœ‡å‹•
        }

        function spawnCoins(x, y, count=5) {
            const world = document.getElementById('game-world');
            const worldRect = world.getBoundingClientRect();
            for(let i=0; i<count; i++) {
                const coin = document.createElement('div');
                coin.className = 'coin-particle';
                coin.style.left = (x - worldRect.left) + 'px'; coin.style.top = (y - worldRect.top) + 'px';
                const tx = (Math.random() - 0.5) * 150; const ty = (Math.random() - 0.5) * 150 - 50;
                coin.style.setProperty('--tx', tx + 'px'); coin.style.setProperty('--ty', ty + 'px');
                world.appendChild(coin); setTimeout(() => coin.remove(), 600);
            }
        }

        window.onload = () => {
            const data = localStorage.getItem('laoge_save_rich_zodiac_fx');
            if(data) {
                const sp = JSON.parse(data);
                document.getElementById('load-btn').style.display = 'block';
                document.getElementById('load-btn').innerText = `ğŸ“œ è¼‰å…¥ï¼šLV.${sp.lv} ${sp.name}`;
            }
        };

        function startNew() { 
            player.name = document.getElementById('name-input').value || "ç„¡åå‹‡è€…"; 
            unlockAudio();
            embark(); 
        }
        function loadGame() { 
            player = JSON.parse(localStorage.getItem('laoge_save_rich_zodiac_fx')); 
            unlockAudio();
            embark(); 
        }

        function embark() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('p-name-tag').innerText = player.name;
            document.querySelectorAll('#player-profile, #shop-panel, #ui-layer, #quick-actions, #log-window').forEach(el => {
                el.style.display = (el.id === 'ui-layer') ? 'grid' : (el.id === 'player-profile' || el.id === 'shop-panel') ? 'flex' : 'block';
            });
            updateUI();
            for(let i=0; i<3; i++) spawnMonster();
            showServerNotice(`æ­¡è¿å‹‡è€… ã€${player.name}ã€‘ é€²å…¥æºèˆˆå¤§æˆ°å ´ï¼`);
        }

        function formatNum(num) {
            if (num >= 1e12) return (num / 1e12).toFixed(1) + 'T';
            if (num >= 1e9) return (num / 1e9).toFixed(1) + 'G';
            if (num >= 1e6) return (num / 1e6).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
            return num;
        }

        function spawnMonster() {
            const dice = Math.random();
            const isMegaBoss = dice < 0.005;
            const isLegendary = !isMegaBoss && dice < 0.025;
            const isBoss = !isMegaBoss && !isLegendary && dice < 0.15;
            
            const z = zodiacs[Math.floor(Math.random()*zodiacs.length)];
            const world = document.getElementById('game-world');
            const growth = 1 + (player.lv * 0.5);
            
            let stats = {
                name: isMegaBoss ? "ğŸ”¥ æ··æ²Œâ€§çµ‚ç„‰ä¹‹ä¸» ğŸ”¥" : (isLegendary ? `ã€ç¥è©±ã€‘å¹´ç¸` : (isBoss ? `ã€ç²¾éŠ³ã€‘${z.n}` : z.n)),
                maxHp: isMegaBoss ? 100000000000 : (isLegendary ? 500000000 : Math.floor(200 * growth * (isBoss ? 20 : 1))),
                atk: Math.floor(25 * growth * (isMegaBoss ? 50 : (isLegendary ? 10 : (isBoss ? 2 : 1)))),
                gold: Math.floor(600 * growth * (isMegaBoss ? 5000 : (isLegendary ? 200 : (isBoss ? 15 : 1)))), 
                exp: Math.floor(400 * growth * (isMegaBoss ? 2000 : (isLegendary ? 100 : (isBoss ? 10 : 1)))),
                size: isMegaBoss ? 180 : (isLegendary ? 140 : (isBoss ? 100 : 75)),
                emoji: isMegaBoss ? 'ğŸ‘¹' : (isLegendary ? 'ğŸ²' : z.e)
            };

            const div = document.createElement('div');
            div.className = 'monster';
            if(isMegaBoss) div.classList.add('mega-boss-glow');
            else if(isLegendary) div.classList.add('legendary');
            else if(isBoss) div.classList.add('boss');
            
            let curHp = stats.maxHp;
            div.style.cssText = `width:${stats.size}px; height:${stats.size}px; left:${10 + Math.random()*50}%; top:${15 + Math.random()*30}%;`;
            
            div.innerHTML = `
                <div class="m-name">${stats.name}</div>
                ${stats.emoji}
                <div class="m-hp-bar">
                    <div class="m-hp-fill"></div>
                    <div class="hp-text">${formatNum(curHp)} / ${formatNum(stats.maxHp)}</div>
                </div>
            `;

            const hitMonster = (cX, cY) => {
                playSound('hit'); 
                doVibrate(15); // æ™®é€šæ‰“æ“Šéœ‡å‹•
                showVisualFX(cX, cY);
                spawnCoins(cX, cY, isMegaBoss ? 20 : 5);
                curHp -= player.atk;
                player.hp -= Math.max(1, stats.atk - player.def);
                
                if(player.hp <= 0) { alert("ä¸€ä½å‹‡è€…å£¯çƒˆçŠ§ç‰²äº†...é‡æ–°è¼ªè¿´ä¸­~~~"); exitGame(); return; }
                
                if(curHp <= 0) {
                    playSound('kill'); 
                    doVibrate(40); // æ“Šæ®ºé‡éœ‡
                    triggerScreenShake();
                    spawnCoins(cX, cY, isMegaBoss ? 100 : 25);
                    player.gold += stats.gold; player.exp += stats.exp; player.ult += (isMegaBoss?100:(isLegendary?50:20)); player.kills++;
                    
                    if(isMegaBoss) showServerNotice(`ç‹‚è³€ï¼å‹‡è€… ã€${player.name}ã€‘ æˆåŠŸè¨ä¼äº†å„„è¬ç´šç¥ç¸ã€æ··æ²Œâ€§çµ‚ç„‰ä¹‹ä¸»ã€‘ï¼`);
                    else if(isLegendary) showServerNotice(`å‹‡è€… ã€${player.name}ã€‘ æ“Šæ•—äº†ç¥è©±å¹´ç¸ï¼Œä¸–ç•Œé‡ç²å’Œå¹³ï¼`);
                    
                    div.remove();
                    addLog(`æ“Šæ•—${stats.name}ï¼`);
                    checkLevelUp(); spawnMonster();
                    if(player.ult >= 100) castUlt();
                } else {
                    const fill = div.querySelector('.m-hp-fill');
                    const text = div.querySelector('.hp-text');
                    fill.style.width = (curHp / stats.maxHp * 100) + "%";
                    text.innerText = `${formatNum(Math.max(0, curHp))} / ${formatNum(stats.maxHp)}`;
                }
                updateUI();
            };

            div.onmousedown = (e) => { e.preventDefault(); hitMonster(e.clientX, e.clientY); };
            div.hitAction = hitMonster;
            world.appendChild(div);
        }

        function showVisualFX(x, y) {
            const worldRect = document.getElementById('game-world').getBoundingClientRect();
            const slash = document.createElement('div');
            slash.className = 'slash-fx';
            slash.style.left = (x - worldRect.left) + 'px'; slash.style.top = (y - worldRect.top) + 'px'; 
            slash.style.width = '120px';
            slash.style.setProperty('--rot', (Math.random() * 360) + 'deg');
            document.getElementById('game-world').appendChild(slash);
            setTimeout(() => slash.remove(), 100);
        }

        function toggleAuto() {
            isAuto = !isAuto;
            const btn = document.getElementById('auto-toggle');
            if(isAuto) {
                unlockAudio();
                btn.innerText = "ğŸ¤– è‡ªå‹•ï¼šé–‹å•Ÿ"; btn.style.background = "#2ecc71";
                autoTimer = setInterval(() => {
                    const ms = document.querySelectorAll('.monster');
                    if(ms.length > 0) {
                        const target = ms[Math.floor(Math.random() * ms.length)];
                        const rect = target.getBoundingClientRect();
                        target.hitAction(rect.left + rect.width/2, rect.top + rect.height/2);
                    }
                }, 350); 
            } else {
                btn.innerText = "ğŸ¤– è‡ªå‹•ï¼šé—œé–‰"; btn.style.background = "#8e44ad";
                clearInterval(autoTimer);
            }
        }

        function castUlt() {
            player.ult = 0; 
            playSound('lvUp'); 
            doVibrate([100, 50, 100]); // å¤§æ‹›ä¸‰é€£éœ‡
            triggerScreenShake();
            addLog("ğŸ’¥ è¬ç¸ä¿±æ»…ï¼");
            document.querySelectorAll('.monster').forEach(m => { 
                const r = m.getBoundingClientRect();
                spawnCoins(r.left+r.width/2, r.top+r.height/2, 20);
                player.gold += 5000; player.exp += 2000; m.remove(); 
            });
            setTimeout(() => { for(let i=0; i<3; i++) spawnMonster(); updateUI(); }, 400);
        }

        function checkLevelUp() {
            while(player.exp >= player.expNext) {
                player.lv++; player.exp -= player.expNext;
                player.expNext = Math.floor(player.expNext * 1.6);
                player.maxHp += 2000; player.hp = player.maxHp;
                player.atk += 300; player.def += 150;
                playSound('lvUp'); 
                doVibrate([50, 30, 50]); 
                if(player.lv % 10 === 0) showServerNotice(`å¼·å¤§ï¼å‹‡è€… ã€${player.name}ã€‘ ç­‰ç´šçªç ´è‡³ LV.${player.lv}ï¼`);
                addLog(`âœ¨ LV.${player.lv}ï¼`);
            }
        }

        function updateUI() {
            document.getElementById('p-lv').innerText = player.lv;
            document.getElementById('p-hp').innerText = Math.max(0, player.hp).toLocaleString();
            document.getElementById('p-max').innerText = player.maxHp.toLocaleString();
            document.getElementById('p-atk').innerText = player.atk.toLocaleString();
            document.getElementById('p-def').innerText = player.def.toLocaleString();
            document.getElementById('p-gold').innerText = `$ ${player.gold.toLocaleString()}`;
            document.getElementById('p-kills').innerText = player.kills;
            document.getElementById('exp-fill').style.width = (player.exp / player.expNext * 100) + "%";
            document.getElementById('ult-fill').style.width = Math.min(100, player.ult) + "%";
            document.getElementById('ult-pct').innerText = Math.min(100, player.ult) + "%";
            
            let u = getActualUnits('atk');
            document.getElementById('price-atk').innerText = `$ ${(500*u).toLocaleString()}`;
            document.getElementById('price-def').innerText = `$ ${(500*u).toLocaleString()}`;
            document.getElementById('price-hp').innerText = `$ ${(800*u).toLocaleString()}`;
            document.getElementById('price-lv').innerText = `$ ${(5000 + (player.lv * 1500)).toLocaleString()}`;
            if(player.avatar) { document.getElementById('player-avatar-img').src = player.avatar; document.getElementById('player-avatar-img').style.display = 'block'; document.getElementById('def-icon').style.display = 'none'; }
        }

        function getActualUnits(type) {
            let base = (type === 'hp' ? 800 : 500);
            return buyUnit === 'max' ? Math.max(1, Math.floor(player.gold / base)) : buyUnit;
        }

        function buy(type) {
            let units = getActualUnits(type);
            let cost = (type==='hp'?800:500) * units;
            if(player.gold >= cost) {
                player.gold -= cost;
                if(type === 'atk') player.atk += (40 * units);
                if(type === 'def') player.def += (25 * units);
                if(type === 'hp') { player.maxHp += (1000 * units); player.hp += (1000 * units); }
                doVibrate(20);
                updateUI();
            }
        }

        function buyLv() {
            let cost = 5000 + (player.lv * 1500);
            if(player.gold >= cost) { player.gold -= cost; player.exp = player.expNext; checkLevelUp(); updateUI(); }
        }

        function setBuyUnit(u, btn) {
            buyUnit = u;
            document.querySelectorAll('.buy-unit-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active'); updateUI();
        }
        function handleAvatar(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = e => { player.avatar = e.target.result; updateUI(); }; reader.readAsDataURL(input.files[0]); } }
        function addLog(msg) {
            const log = document.getElementById('log-window');
            const entry = document.createElement('div');
            entry.innerHTML = `> ${msg}`;
            log.prepend(entry);
        }
        function saveGame(m) { localStorage.setItem('laoge_save_rich_zodiac_fx', JSON.stringify(player)); if(m) alert("å­˜æª”æˆåŠŸï¼"); }
        function exitGame() { 
            sounds.bgm.pause(); 
            saveGame(false); 
            location.reload(); 
        }
    </script>
</body>
</html>